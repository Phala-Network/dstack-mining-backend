# dstack Mining Backend

dstack GPU mining backend service, responsible for monitoring GPU status, registering nodes with the registry center, and communicating with the message network.

## Prerequisites

**IMPORTANT**: Before deploying this backend service, you must:

1. **Run dstack on the host machine** with GPU passthrough enabled
2. **Provide GPU resources** to the dstack service
3. Ensure the dstack service is accessible at `localhost:14520`
4. Ensure the dstack VMM port is configured to listen on 0.0.0.0 (it defaults to 127.0.0.1). This is required for Docker container access. You can verify the port binding status using `sudo netstat -tulnp | grep 14520`

Without a properly configured dstack service with GPU resources on the host machine, **you will not be able to earn rewards**.

## Architecture

```
┌─────────────────────┐
│   Registry Server   │  ← Verify and manage all worker nodes
│                     │
└─────────────────────┘
          ↑
          │ Registration + Authentication
          │
┌─────────────────────┐
│  dstack Backend     │  ← Monitor GPU + Auto registration
│   (This Project)    │
└─────────────────────┘
          ↑                ↑
          │                │
          ↓                │ Read Nostr key
┌─────────────────────┐    │
│   dstack Service    │    │
│  (GPU Scheduler)    │    │
│   Port: 14520       │    │
└─────────────────────┘    │
                           │
                  ┌────────┴────────┐
                  │  Dephy Worker   │  ← Message network communication
                  │   Port: 9001    │
                  └─────────────────┘
```

## Components

### 1. dstack Backend (This Project)
**Role**: GPU node backend service

**Functions**:
- Monitor dstack GPU status
- Generate/load Nostr keypair (stored in `data/key`)
- Automatically register node with registry center
- Provide health check API (`/health`)
- **Only starts after successful registration**

### 2. Dephy Worker (Included in docker-compose)
**Role**: Worker for message network communication

**Functions**:
- Read Nostr keys generated by Backend
- Connect to message network
- Handle task distribution

**Dependency**: Backend must start and register successfully first

### 3. Registry Server (External Service)
**Role**: Centralized node registration and authentication service

**Functions**:
- Receive worker node registrations
- Verify node permissions
- Manage node whitelist

**You need to provide**: `REGISTRY_URL` configuration

### 4. dstack Service (External Service)
**Role**: GPU virtualization and scheduling service

**Functions**: Provide GPU resource information

**You need to provide**: dstack service running on local machine at `localhost:14520`

## Quick Start

### 1. Configure Environment Variables

```bash
# Copy configuration file
cp .env.example .env

# Edit .env file and fill in required parameters
nano .env
```

Required configuration:
```bash
# Registry center address (required)
REGISTRY_URL=http://your-registry-server:9200

# Ethereum owner address (required)
OWNER_ADDRESS=0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb

# Node type (optional, defaults to node-H100x1)
NODE_TYPE=node-H100x1

# Worker image version (optional, use v2.0.0 for production)
DEPHY_WORKER_IMAGE_TAG=v2.1.0
```

### 2. Start Services

```bash
docker compose up -d
```

### 3. View Logs

```bash
# View startup logs to confirm successful registration
docker compose logs -f dstack-backend
```

After successful startup, you should see:
```
INFO Worker registration completed successfully
INFO Worker is now authorized to communicate with the message network
INFO Backend listening on 0.0.0.0:8080
```

## Environment Variables

### Basic Configuration
| Variable | Description | Default Value |
|----------|-------------|---------------|
| `DSTACK_BACKEND_DSTACK_URL` | dstack service address. Supports both HTTP (e.g., `http://host.docker.internal:14520`) and Unix socket (e.g., `unix:///opt/dstack/dstack-v05x/run/teepod.sock`) | `http://host.docker.internal:14520` |
| `LISTEN_ADDR` | Backend listening address | `0.0.0.0:8080` |
| `DATA_DIR` | Data directory (key storage) | `./data` |

### Registration Configuration (Required)
| Variable | Description | Required |
|----------|-------------|----------|
| `REGISTRY_URL` | Registry center address | ✅ Required |
| `OWNER_ADDRESS` | Ethereum owner address | ✅ Required |
| `NODE_TYPE` | Node type | Optional (defaults to `node-H100x1`) |

**Important**: Missing `REGISTRY_URL` or `OWNER_ADDRESS` will prevent the service from starting.

## API Endpoints

### GET /health
Returns Backend health status and GPU information

**Response Example**:
```json
{
  "version": "1.0.0",
  "topic": "dstack-gpu-monitor",
  "pubkeys": ["abc123..."],
  "status": "Available",
  "metadata": "{\"gpu_count\":1,\"gpus\":[...]}",
  "ip_address": "192.168.1.100"
}
```

### GET /
Returns basic service information

## Registration Flow

Backend automatically executes on startup:

1. **Generate keypair**: Save Nostr private key in `data/key` file
2. **Check registration status**: `GET /permissions/<pubkey>`
3. **Auto-register** (if not registered):
   ```
   POST /workers
   Body: {
     "pubkey": "<nostr_pubkey_hex>",
     "owner": "<ethereum_address>",
     "node_type": "node-H100x1"
   }
   ```
4. **Start service**: After successful registration, start HTTP service

⚠️ **Registration failure will cause service to exit**. Error logs will show the reason for failure.

## Troubleshooting

### Startup Failed: Missing Environment Variables
```
Error: REGISTRY_URL environment variable is required for worker registration
```
**Solution**: Configure `REGISTRY_URL` and `OWNER_ADDRESS` in `.env` file

### Registration Failed
```
ERROR Worker registration failed: ...
ERROR Cannot start service without successful registration
```
**Solution**:
1. Check if registry server is running
2. Check if `REGISTRY_URL` is correct
3. Check network connectivity

### dstack Connection Failed
```
ERROR Failed to connect to dstack: ...
```
**Solution**:
1. Ensure dstack service is running at `localhost:14520`
2. Check `DSTACK_BACKEND_DSTACK_URL` configuration
3. If using Unix socket (e.g., `unix:///opt/dstack/dstack-v05x/run/teepod.sock`):
   - Verify the socket file exists: `ls -l /opt/dstack/dstack-v05x/run/teepod.sock`
   - Ensure the Docker container has access to the socket (mount it as a volume)
   - Check socket permissions

## License

MIT
