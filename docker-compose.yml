services:
  # 中心化的Whitelist服务 - 只需部署一次
  whitelist:
    image: dstack-whitelist:latest
    build:
      context: .
      dockerfile: Dockerfile.whitelist
    container_name: whitelist-service
    ports:
      - "8082:8082"  # 可以改为其他端口，如 "8888:8082"
    environment:
      - LISTEN_ADDR=0.0.0.0:8082
      - WHITELIST_FILE=/data/whitelist.json
    volumes:
      - ./whitelist-data:/data
    restart: unless-stopped
    networks:
      - dstack-network

  # Backend示例 - 可以在多台机器上部署
  backend1:
    image: dstack-backend:latest
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: dstack-backend-1
    ports:
      - "8080:8080"
    environment:
      - LISTEN_ADDR=0.0.0.0:8080
      - DSTACK_URL=http://host.docker.internal:14520
      - DATA_DIR=/data
    volumes:
      - ./backend1-data:/data
    restart: unless-stopped
    networks:
      - dstack-network
    depends_on:
      - whitelist

networks:
  dstack-network:
    driver: bridge
